<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L1 Cache - CS Study System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Configura√ß√£o Tailwind Customizada -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a' },
                        primary: { 500: '#3b82f6', 600: '#2563eb' } // Azul padr√£o
                    },
                    animation: {
                        'flip': 'flip 0.6s forwards',
                    }
                }
            }
        }
    </script>

    <style>
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        body { background-color: #0f172a; color: #e2e8f0; }

        /* Estilos para o Conte√∫do Rico (Rich Text) dentro dos cards */
        .prose pre { background: #1e293b; padding: 0.5rem; border-radius: 0.25rem; font-family: 'Fira Code', monospace; overflow-x: auto; border: 1px solid #334155; }
        .prose code { background: #334155; padding: 0.1rem 0.3rem; border-radius: 0.2rem; color: #60a5fa; font-family: monospace; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-top: 0.5rem; }
        .prose strong { color: #60a5fa; font-weight: bold; }
        .prose em { color: #facc15; font-style: italic; }
        .prose p { margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
            signOut, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, getDocs, doc, 
            setDoc, deleteDoc, updateDoc, serverTimestamp, query, where, increment, orderBy, limit 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyClIIJkYOmAvEKPtXvG-SIi9SzxQpaBN9s",
            authDomain: "ankidigital.firebaseapp.com",
            projectId: "ankidigital",
            storageBucket: "ankidigital.firebasestorage.app",
            messagingSenderId: "407660648093",
            appId: "1:407660648093:web:b7bf69730e90a28cb36674"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ALGORITMO ANKI AVAN√áADO ---
        const calculateNextReview = (rating, currentData) => {
            const interval = currentData?.interval || 0;
            const ease = currentData?.ease || 2.5;
            const state = currentData?.state || 'learning';

            let newInterval = 0;
            let newEase = ease;
            let newState = state;

            if (state === 'learning') {
                if (rating === 1) { newInterval = 5; newState = 'learning'; }
                else if (rating === 2) { newInterval = 10; newState = 'learning'; }
                else if (rating === 3) { 
                    newInterval = 15; 
                    if (interval >= 15) { newInterval = 1440; newState = 'graduated'; }
                    else { newState = 'learning'; }
                } 
                else if (rating === 4) { newInterval = 1440; newState = 'graduated'; }
            } else {
                if (rating === 1) { newInterval = 10; newEase = Math.max(1.3, ease - 0.2); newState = 'learning'; }
                else if (rating === 2) { newInterval = Math.floor(interval * 1.2); newEase = Math.max(1.3, ease - 0.15); newState = 'graduated'; }
                else if (rating === 3) { newInterval = Math.floor(interval * ease); newState = 'graduated'; }
                else if (rating === 4) { newInterval = Math.floor(interval * ease * 1.3); newEase = ease + 0.15; newState = 'graduated'; }
            }

            const now = new Date();
            const dueDate = new Date(now.getTime() + newInterval * 60000);

            return { interval: newInterval, ease: newEase, state: newState, dueDate: dueDate };
        };

        const formatTime = (minutes) => {
            if (minutes < 60) return `${minutes} min`;
            if (minutes < 1440) return `${Math.round(minutes/60)} h`;
            return `${Math.round(minutes/1440)} dias`;
        };

        const simulateOptions = (currentData) => {
            return {
                1: calculateNextReview(1, currentData),
                2: calculateNextReview(2, currentData),
                3: calculateNextReview(3, currentData),
                4: calculateNextReview(4, currentData),
            }
        };

        const Icons = {
            Brain: () => <i data-lucide="cpu" className="w-6 h-6 text-blue-500"></i>, // Mudado para CPU para combinar com "Cache"
            Zap: () => <i data-lucide="zap" className="w-6 h-6 text-yellow-400"></i>,
            LogOut: () => <i data-lucide="log-out" className="w-4 h-4"></i>,
            Plus: () => <i data-lucide="plus" className="w-4 h-4"></i>,
            Trash: () => <i data-lucide="trash-2" className="w-4 h-4"></i>,
            Edit: () => <i data-lucide="pencil" className="w-4 h-4"></i>,
            Check: () => <i data-lucide="check" className="w-4 h-4"></i>,
            X: () => <i data-lucide="x" className="w-4 h-4"></i>,
            Folder: () => <i data-lucide="folder" className="w-4 h-4 text-amber-500"></i>,
            Lock: () => <i data-lucide="lock" className="w-4 h-4"></i>,
            Clock: () => <i data-lucide="clock" className="w-4 h-4"></i>,
            Trophy: () => <i data-lucide="trophy" className="w-4 h-4 text-yellow-500"></i>,
            Bold: () => <i data-lucide="bold" className="w-3 h-3"></i>,
            Italic: () => <i data-lucide="italic" className="w-3 h-3"></i>,
            Code: () => <i data-lucide="code" className="w-3 h-3"></i>,
            List: () => <i data-lucide="list" className="w-3 h-3"></i>
        };

        // --- COMPONENTE EDITOR RICO ---
        const RichTextEditor = ({ value, onChange, placeholder }) => {
            const execCmd = (cmd) => {
                document.execCommand(cmd, false, null);
            };

            const execBlock = (tag) => {
                document.execCommand('formatBlock', false, tag);
            };

            return (
                <div className="bg-slate-900 border border-slate-700 rounded overflow-hidden flex flex-col h-40 group focus-within:border-blue-500 transition-colors">
                    <div className="bg-slate-800 p-2 flex gap-2 border-b border-slate-700">
                        <button type="button" onClick={() => execCmd('bold')} className="p-1 hover:bg-slate-700 rounded text-slate-300 transition-colors" title="Negrito"><Icons.Bold/></button>
                        <button type="button" onClick={() => execCmd('italic')} className="p-1 hover:bg-slate-700 rounded text-slate-300 transition-colors" title="It√°lico"><Icons.Italic/></button>
                        <button type="button" onClick={() => execCmd('insertUnorderedList')} className="p-1 hover:bg-slate-700 rounded text-slate-300 transition-colors" title="Lista"><Icons.List/></button>
                        <button type="button" onClick={() => execBlock('pre')} className="p-1 hover:bg-slate-700 rounded text-blue-400 font-mono text-xs border border-slate-600 px-2 transition-colors" title="Bloco de C√≥digo">&lt;/&gt;</button>
                    </div>
                    <div 
                        className="flex-1 p-3 text-white focus:outline-none overflow-y-auto prose text-sm"
                        contentEditable
                        onInput={(e) => onChange(e.currentTarget.innerHTML)}
                        dangerouslySetInnerHTML={{__html: value}}
                        style={{minHeight: '100px'}}
                    ></div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [isAdmin, setIsAdmin] = React.useState(false);
            const [view, setView] = React.useState("loading"); 
            const [cards, setCards] = React.useState([]);
            const [reviews, setReviews] = React.useState({});
            const [studyQueue, setStudyQueue] = React.useState([]);
            
            React.useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            React.useEffect(() => {
                const unsub = onAuthStateChanged(auth, async (currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        setIsAdmin(currentUser.email.endsWith("@userpro.com"));
                        await loadUserData(currentUser);
                    } else {
                        setIsAdmin(false);
                        setReviews({});
                        await loadPublicCards();
                    }
                    setView(currentUser ? "decks" : "auth");
                });
                return () => unsub();
            }, []);

            const loadPublicCards = async () => {
                try {
                    const q = query(collection(db, "cards"));
                    const snapshot = await getDocs(q);
                    const loadedCards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setCards(loadedCards);
                } catch (error) {
                    console.error("Erro cards:", error);
                }
            };

            const loadUserData = async (currentUser) => {
                await loadPublicCards();
                try {
                    const q = query(collection(db, `users/${currentUser.uid}/reviews`));
                    const snapshot = await getDocs(q);
                    const userReviews = {};
                    snapshot.forEach(doc => {
                        userReviews[doc.id] = doc.data();
                    });
                    setReviews(userReviews);
                } catch (error) {
                    console.error("Erro progresso:", error);
                }
            };

            const getDecksStructure = () => {
                const structure = {};
                cards.forEach(card => {
                    const cat = card.category || "Geral";
                    const sub = card.subcategory || "Geral";
                    if (!structure[cat]) structure[cat] = {};
                    if (!structure[cat][sub]) structure[cat][sub] = [];
                    structure[cat][sub].push(card);
                });
                return structure;
            };

            const startStudy = (category, subcategory = null, forceCram = false) => {
                const now = new Date();
                let queue = cards.filter(c => {
                    if (category && c.category !== category) return false;
                    if (subcategory && c.subcategory !== subcategory) return false;
                    return true;
                });

                if (user && !forceCram) {
                    queue = queue.filter(card => {
                        const review = reviews[card.id];
                        if (!review) return true; // Novo
                        const dueDate = review.dueDate.toDate ? review.dueDate.toDate() : new Date(review.dueDate);
                        return dueDate <= now; // Vencido
                    });
                } else if (!user) {
                    queue = queue.sort(() => Math.random() - 0.5);
                }
                
                if (forceCram) queue = queue.sort(() => Math.random() - 0.5);

                if (queue.length === 0 && !forceCram) {
                    if (confirm("Voc√™ est√° em dia! Deseja revisar cards aleat√≥rios (Modo Extra)?")) {
                        startStudy(category, subcategory, true);
                    }
                    return;
                }

                if (queue.length === 0 && forceCram) {
                    alert("Baralho vazio.");
                    return;
                }

                setStudyQueue(queue);
                setView("study");
            };

            if (view === "loading") return <div className="min-h-screen flex items-center justify-center bg-slate-900 text-blue-500 animate-pulse"><Icons.Brain /> Inicializando L1 Cache...</div>;
            if (view === "auth") return <AuthScreen onLogin={() => setView("decks")} guestMode={() => setView("decks")} />;

            return (
                <div className="min-h-screen flex flex-col bg-slate-900 text-slate-200 font-sans selection:bg-blue-500/30">
                    <nav className="border-b border-slate-800 bg-slate-900/95 sticky top-0 z-50 backdrop-blur">
                        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2 font-bold text-xl cursor-pointer group" onClick={() => setView("decks")}>
                                <div className="bg-blue-500/10 p-2 rounded-lg group-hover:bg-blue-500/20 transition-colors">
                                    <Icons.Brain />
                                </div>
                                <span className="text-white tracking-tight">L1 <span className="text-blue-500">Cache</span></span>
                            </div>
                            <div className="flex items-center gap-4">
                                {user && <button onClick={() => setView("leaderboard")} className="text-yellow-500 flex items-center gap-1 text-sm hover:text-yellow-400 font-medium bg-yellow-500/10 px-3 py-1.5 rounded-full border border-yellow-500/20 transition-all hover:bg-yellow-500/20"><Icons.Trophy /> Ranking</button>}
                                {isAdmin && <button onClick={() => setView("admin")} className="text-amber-500 hover:text-amber-400 bg-amber-500/10 px-3 py-1.5 rounded-full border border-amber-500/20 transition-all hover:bg-amber-500/20 flex items-center gap-1"><Icons.Lock size={14} /> Admin</button>}
                                {user ? <button onClick={() => signOut(auth)} className="text-slate-400 hover:text-red-400 transition-colors"><Icons.LogOut /></button> : null}
                            </div>
                        </div>
                    </nav>

                    <main className="flex-1 max-w-6xl mx-auto w-full p-4">
                        {view === "decks" && <DecksView structure={getDecksStructure()} startStudy={startStudy} totalCards={cards.length} reviews={reviews} />}
                        {view === "study" && <StudySession queue={studyQueue} user={user} reviews={reviews} setReviews={setReviews} onFinish={() => setView("decks")} />}
                        {view === "leaderboard" && <LeaderboardView />}
                        {view === "admin" && isAdmin && <AdminPanel cards={cards} setCards={setCards} onExit={() => setView("decks")} />}
                    </main>
                </div>
            );
        };

        const AuthScreen = ({ onLogin, guestMode }) => {
            const [isRegister, setIsRegister] = React.useState(false);
            const [email, setEmail] = React.useState("");
            const [password, setPassword] = React.useState("");
            const [loading, setLoading] = React.useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    if (isRegister) await createUserWithEmailAndPassword(auth, email, password);
                    else await signInWithEmailAndPassword(auth, email, password);
                    onLogin();
                } catch (err) {
                    alert(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-900 relative overflow-hidden">
                    {/* Background decoration */}
                    <div className="absolute top-[-10%] left-[-10%] w-96 h-96 bg-blue-600/10 rounded-full blur-3xl"></div>
                    <div className="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-indigo-600/10 rounded-full blur-3xl"></div>

                    <div className="w-full max-w-md bg-slate-800/80 backdrop-blur-xl p-8 rounded-2xl border border-slate-700 shadow-2xl relative z-10">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-blue-500/20 rounded-2xl flex items-center justify-center mx-auto mb-4 text-blue-400 ring-1 ring-blue-500/40">
                                <Icons.Brain />
                            </div>
                            <h1 className="text-3xl font-bold text-white mb-2">L1 Cache</h1>
                            <p className="text-slate-400 text-sm">A mem√≥ria mais r√°pida para o estudante de elite.</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Credenciais</label>
                                <input type="email" placeholder="Email Acad√™mico" className="w-full bg-slate-900/50 border border-slate-700 focus:border-blue-500 p-3 rounded-lg text-white outline-none transition-all" value={email} onChange={e => setEmail(e.target.value)} />
                                <input type="password" placeholder="Senha" className="w-full bg-slate-900/50 border border-slate-700 focus:border-blue-500 p-3 rounded-lg text-white outline-none transition-all" value={password} onChange={e => setPassword(e.target.value)} />
                            </div>
                            <button className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold p-3 rounded-lg shadow-lg shadow-blue-900/20 transition-all transform hover:scale-[1.02]">
                                {loading ? "Acessando mem√≥ria..." : (isRegister ? "Registrar Matr√≠cula" : "Acessar Sistema")}
                            </button>
                        </form>
                        <div className="mt-6 flex justify-between text-sm text-slate-500 pt-4 border-t border-slate-700">
                            <button onClick={() => setIsRegister(!isRegister)} className="hover:text-blue-400 transition-colors">{isRegister ? "J√° tenho conta" : "Criar nova conta"}</button>
                            <button onClick={guestMode} className="hover:text-white transition-colors">Modo Visitante</button>
                        </div>
                    </div>
                </div>
            );
        };

        const DecksView = ({ structure, startStudy, totalCards, reviews }) => {
            return (
                <div className="animate-fade-in space-y-6">
                    <header className="border-b border-slate-800 pb-6 flex justify-between items-end">
                        <div>
                            <h2 className="text-3xl font-bold text-white mb-2">Meus Decks</h2>
                            <p className="text-slate-400 text-sm flex gap-4">
                                <span><strong className="text-blue-400">{totalCards}</strong> Cards Totais</span>
                                <span><strong className="text-emerald-400">{Object.keys(reviews).length}</strong> Em Mem√≥ria</span>
                            </p>
                        </div>
                    </header>
                    
                    <div className="grid gap-6">
                        {Object.keys(structure).sort().map(cat => (
                            <div key={cat} className="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 hover:border-slate-600 transition-colors shadow-lg">
                                <div className="p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center bg-gradient-to-r from-slate-800 to-slate-800/50">
                                    <h3 className="font-bold text-lg text-white flex items-center gap-2"><Icons.Folder /> {cat}</h3>
                                    <button onClick={() => startStudy(cat)} className="bg-blue-600 hover:bg-blue-500 text-white text-xs px-4 py-2 rounded-lg font-bold shadow-lg shadow-blue-900/20 transition-all flex items-center gap-1">
                                        <Icons.Zap size={14} className="text-white"/> Estudar Categoria
                                    </button>
                                </div>
                                <div className="p-2 bg-slate-900/30">
                                    {Object.keys(structure[cat]).map(sub => (
                                        <div key={sub} className="flex justify-between items-center p-3 hover:bg-slate-700/50 rounded-lg group cursor-pointer transition-colors" onClick={() => startStudy(cat, sub)}>
                                            <span className="text-slate-300 font-medium flex items-center gap-3">
                                                <div className="w-1.5 h-1.5 bg-slate-600 rounded-full group-hover:bg-blue-500 group-hover:scale-150 transition-all"></div> 
                                                {sub}
                                            </span>
                                            <span className="text-xs bg-slate-800 text-slate-400 px-2.5 py-1 rounded-md border border-slate-700 font-mono">{structure[cat][sub].length}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- COMPONENTE LEADERBOARD ---
        const LeaderboardView = () => {
            const [leaders, setLeaders] = React.useState([]);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                const load = async () => {
                    try {
                        const q = query(collection(db, 'leaderboard'), orderBy('retention', 'desc'), limit(50));
                        const snap = await getDocs(q);
                        setLeaders(snap.docs.map(d => d.data()));
                    } catch (e) {
                        console.error(e);
                    } finally {
                        setLoading(false);
                    }
                };
                load();
            }, []);

            return (
                <div className="max-w-4xl mx-auto animate-fade-in">
                    <div className="flex items-center gap-4 mb-8">
                        <div className="p-3 bg-yellow-500/10 rounded-xl border border-yellow-500/20">
                            <Icons.Trophy />
                        </div>
                        <div>
                            <h2 className="text-3xl font-bold text-white">Ranking Global</h2>
                            <p className="text-slate-400 text-sm">Os melhores estudantes da plataforma</p>
                        </div>
                    </div>

                    <div className="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 shadow-xl">
                        <table className="w-full text-left border-collapse">
                            <thead className="bg-slate-900/80 text-slate-400 uppercase text-xs font-bold tracking-wider">
                                <tr>
                                    <th className="p-5 border-b border-slate-700">Rank</th>
                                    <th className="p-5 border-b border-slate-700">Estudante</th>
                                    <th className="p-5 border-b border-slate-700 text-center">XP (Cards)</th>
                                    <th className="p-5 border-b border-slate-700 text-center">Reten√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700/50">
                                {leaders.map((l, i) => (
                                    <tr key={i} className="hover:bg-slate-700/30 transition-colors">
                                        <td className="p-5 font-bold text-slate-500 font-mono">#{i+1}</td>
                                        <td className="p-5 text-white font-medium flex items-center gap-2">
                                            {i === 0 && <span className="text-xl">üëë</span>}
                                            {i === 1 && <span className="text-xl">ü•à</span>}
                                            {i === 2 && <span className="text-xl">ü•â</span>}
                                            {l.email ? l.email.split('@')[0] : 'An√¥nimo'}
                                        </td>
                                        <td className="p-5 text-center text-blue-400 font-mono font-bold bg-blue-500/5">{l.total || 0}</td>
                                        <td className="p-5 text-center">
                                            <span className={`px-3 py-1 rounded-full text-xs font-bold border ${l.retention > 80 ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20'}`}>
                                                {l.retention ? l.retention.toFixed(1) : 0}%
                                            </span>
                                        </td>
                                    </tr>
                                ))}
                                {leaders.length === 0 && !loading && (
                                    <tr><td colSpan="4" className="p-12 text-center text-slate-500">Nenhum dado ainda. Seja o primeiro a estudar!</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const StudySession = ({ queue, user, reviews, setReviews, onFinish }) => {
            const [index, setIndex] = React.useState(0);
            const [isFlipped, setIsFlipped] = React.useState(false);
            const [finished, setFinished] = React.useState(false);

            if (finished || queue.length === 0) {
                return (
                    <div className="flex flex-col items-center justify-center h-[60vh] text-center animate-fade-in">
                        <div className="w-24 h-24 bg-emerald-500/10 rounded-full flex items-center justify-center text-emerald-500 mb-6 border border-emerald-500/20">
                            <Icons.Check />
                        </div>
                        <h2 className="text-3xl font-bold text-white mb-2">Sess√£o Finalizada</h2>
                        <p className="text-slate-400 mb-8">Dados salvos na mem√≥ria L1.</p>
                        <button onClick={onFinish} className="bg-slate-700 hover:bg-slate-600 text-white px-8 py-3 rounded-lg font-bold transition-all shadow-lg">Voltar ao Dashboard</button>
                    </div>
                );
            }

            const card = queue[index];
            const currentData = reviews[card.id] || { interval: 0, ease: 2.5, state: 'learning' };
            const options = simulateOptions(currentData);

            const handleRate = async (rating) => {
                if (user) {
                    const result = calculateNextReview(rating, currentData);
                    const newReviews = { ...reviews, [card.id]: { ...result, dueDate: { toDate: () => result.dueDate } } };
                    setReviews(newReviews);
                    
                    // Salvar Review
                    await setDoc(doc(db, `users/${user.uid}/reviews/${card.id}`), {
                        ...result,
                        lastReviewed: serverTimestamp()
                    });

                    // Atualizar Leaderboard (Atomico)
                    const statsRef = doc(db, 'leaderboard', user.uid);
                    // Precisamos ler primeiro para calcular a reten√ß√£o correta ou usar cloud functions (aqui faremos no client por simplicidade)
                    // Para simplificar no front-end sem transa√ß√µes complexas:
                    try {
                        const snap = await getDocs(query(collection(db, `users/${user.uid}/reviews`)));
                        const total = snap.size;
                        // Estimativa simples de sucesso: cards com intervalo > 1 dia (graduados)
                        const success = snap.docs.filter(d => d.data().state === 'graduated').length;
                        const retention = total > 0 ? (success / total) * 100 : 0;
                        
                        await setDoc(statsRef, {
                            email: user.email,
                            total: total,
                            retention: retention,
                            lastActive: serverTimestamp()
                        }, { merge: true });
                    } catch(e) { console.error("Erro leaderboard", e); }
                }
                
                setIsFlipped(false);
                if (index < queue.length - 1) setTimeout(() => setIndex(index + 1), 150);
                else setFinished(true);
            };

            return (
                <div className="max-w-3xl mx-auto mt-8 h-[75vh] flex flex-col perspective-1000">
                    <div className="flex justify-between text-xs text-slate-500 uppercase tracking-widest mb-4 px-2">
                        <span>{card.category} / {card.subcategory}</span>
                        <span>Card {index + 1} de {queue.length}</span>
                    </div>
                    
                    <div className="relative flex-1 cursor-pointer group" onClick={() => setIsFlipped(!isFlipped)}>
                        <div className={`w-full h-full duration-500 transform-style-3d transition-transform relative ${isFlipped ? 'rotate-y-180' : ''}`}>
                            <div className="absolute inset-0 backface-hidden bg-slate-800 border border-slate-700 rounded-2xl p-10 flex flex-col items-center justify-center text-center shadow-2xl overflow-hidden group-hover:border-slate-600 transition-colors">
                                <h3 className="text-2xl font-medium text-white prose select-none" dangerouslySetInnerHTML={{__html: card.front}}></h3>
                                <p className="absolute bottom-6 text-xs text-slate-500 font-mono opacity-50">CLIQUE PARA REVELAR</p>
                            </div>
                            <div className="absolute inset-0 backface-hidden rotate-y-180 bg-slate-800 border-2 border-blue-600/30 rounded-2xl p-8 flex flex-col items-center justify-center text-center shadow-2xl overflow-hidden">
                                <div className="text-lg text-blue-100 overflow-y-auto w-full h-full prose text-left flex flex-col items-center justify-center" dangerouslySetInnerHTML={{__html: card.back}}></div>
                            </div>
                        </div>
                    </div>

                    <div className={`grid grid-cols-4 gap-3 mt-6 transition-all duration-300 ${isFlipped ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4 pointer-events-none'}`}>
                        <button onClick={(e) => { e.stopPropagation(); handleRate(1); }} className="p-3 rounded-xl bg-red-500/10 border border-red-500/20 text-red-400 hover:bg-red-500/20 flex flex-col items-center transition-all hover:scale-105 active:scale-95">
                            <span className="font-bold text-sm">Errei</span>
                            <span className="text-[10px] opacity-70 font-mono mt-1">{formatTime(options[1].interval)}</span>
                        </button>
                        <button onClick={(e) => { e.stopPropagation(); handleRate(2); }} className="p-3 rounded-xl bg-slate-700/50 border border-slate-600 text-slate-300 hover:bg-slate-700 flex flex-col items-center transition-all hover:scale-105 active:scale-95">
                            <span className="font-bold text-sm">Dif√≠cil</span>
                            <span className="text-[10px] opacity-70 font-mono mt-1">{formatTime(options[2].interval)}</span>
                        </button>
                        <button onClick={(e) => { e.stopPropagation(); handleRate(3); }} className="p-3 rounded-xl bg-blue-500/10 border border-blue-500/20 text-blue-400 hover:bg-blue-500/20 flex flex-col items-center transition-all hover:scale-105 active:scale-95">
                            <span className="font-bold text-sm">Bom</span>
                            <span className="text-[10px] opacity-70 font-mono mt-1">{formatTime(options[3].interval)}</span>
                        </button>
                        <button onClick={(e) => { e.stopPropagation(); handleRate(4); }} className="p-3 rounded-xl bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 hover:bg-emerald-500/20 flex flex-col items-center transition-all hover:scale-105 active:scale-95">
                            <span className="font-bold text-sm">F√°cil</span>
                            <span className="text-[10px] opacity-70 font-mono mt-1">{formatTime(options[4].interval)}</span>
                        </button>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ cards, setCards, onExit }) => {
            const [form, setForm] = React.useState({ front: '', back: '', category: 'Geral', subcategory: '' });
            const [editingId, setEditingId] = React.useState(null);
            
            const handleSave = async (e) => {
                e.preventDefault();
                if(!form.front || !form.back) return;
                
                try {
                    if (editingId) {
                        await updateDoc(doc(db, "cards", editingId), form);
                        setCards(cards.map(c => c.id === editingId ? { ...c, ...form } : c));
                        setEditingId(null);
                    } else {
                        const ref = await addDoc(collection(db, "cards"), { ...form, createdAt: serverTimestamp() });
                        setCards([...cards, { id: ref.id, ...form }]);
                    }
                    setForm({ ...form, front: '', back: '' });
                } catch (e) {
                    alert("Erro ao salvar: " + e.message);
                }
            };

            const handleEdit = (card) => {
                setForm(card);
                setEditingId(card.id);
            };

            const handleDelete = async (id) => {
                if(confirm("Deletar?")) {
                    await deleteDoc(doc(db, "cards", id));
                    setCards(cards.filter(c => c.id !== id));
                }
            };

            return (
                <div className="bg-slate-800 p-6 rounded-xl border border-slate-700 h-[calc(100vh-100px)] overflow-hidden flex flex-col shadow-2xl">
                    <div className="flex justify-between mb-4 border-b border-slate-700 pb-4">
                        <h2 className="text-xl font-bold text-amber-500 flex items-center gap-2">
                            <Icons.Lock size={18}/> {editingId ? 'Editando Card' : 'Painel Administrativo'}
                        </h2>
                        <button onClick={onExit} className="hover:text-white text-slate-400 transition-colors"><Icons.X /></button>
                    </div>
                    
                    <form onSubmit={handleSave} className="space-y-4 bg-slate-900/50 p-4 rounded-xl mb-6 overflow-y-auto flex-shrink-0 border border-slate-700/50">
                        <div className="grid grid-cols-2 gap-4">
                            <div className="space-y-1">
                                <label className="text-xs font-bold text-slate-500 uppercase ml-1">Categoria Principal</label>
                                <input className="w-full bg-slate-800 p-3 rounded-lg text-white border border-slate-700 focus:border-blue-500 outline-none transition-all" placeholder="Ex: Algoritmos" value={form.category} onChange={e => setForm({...form, category: e.target.value})} list="cat-suggestions" />
                                <datalist id="cat-suggestions">
                                    <option value="Algoritmos" />
                                    <option value="Estrutura de Dados" />
                                    <option value="Arquitetura de Computadores" />
                                </datalist>
                            </div>
                            <div className="space-y-1">
                                <label className="text-xs font-bold text-slate-500 uppercase ml-1">Subcategoria</label>
                                <input className="w-full bg-slate-800 p-3 rounded-lg text-white border border-slate-700 focus:border-blue-500 outline-none transition-all" placeholder="Ex: Ordena√ß√£o" value={form.subcategory} onChange={e => setForm({...form, subcategory: e.target.value})} />
                            </div>
                        </div>
                        
                        <div>
                            <label className="text-xs font-bold text-slate-500 uppercase ml-1 mb-1 block">Frente (Pergunta)</label>
                            <RichTextEditor value={form.front} onChange={(val) => setForm({...form, front: val})} />
                        </div>
                        
                        <div>
                            <label className="text-xs font-bold text-slate-500 uppercase ml-1 mb-1 block">Verso (Resposta)</label>
                            <RichTextEditor value={form.back} onChange={(val) => setForm({...form, back: val})} />
                        </div>

                        <div className="flex gap-3 pt-2">
                            {editingId && <button type="button" onClick={() => { setEditingId(null); setForm({...form, front:'', back:''}); }} className="w-1/3 bg-slate-700 hover:bg-slate-600 text-white font-bold p-3 rounded-lg transition-colors">Cancelar</button>}
                            <button className="flex-1 bg-amber-600 hover:bg-amber-500 text-white font-bold p-3 rounded-lg shadow-lg shadow-amber-900/20 transition-all flex justify-center gap-2">
                                <Icons.Plus size={18} /> {editingId ? "Salvar Altera√ß√µes" : "Adicionar √† Base"}
                            </button>
                        </div>
                    </form>

                    <div className="space-y-2 overflow-y-auto flex-1 pr-2">
                        {cards.map(c => (
                            <div key={c.id} className="flex justify-between bg-slate-900 p-4 rounded-lg text-sm border border-slate-800 hover:border-slate-600 transition-colors group">
                                <div className="truncate w-2/3">
                                    <span className="text-blue-400 text-xs font-mono mb-1 block opacity-70">{c.category} &gt; {c.subcategory}</span>
                                    <div className="truncate text-slate-300 font-medium" dangerouslySetInnerHTML={{__html: c.front.replace(/<[^>]*>?/gm, '')}}></div>
                                </div>
                                <div className="flex gap-2 opacity-50 group-hover:opacity-100 transition-opacity">
                                    <button onClick={() => handleEdit(c)} className="text-blue-400 hover:bg-blue-900/30 p-2 rounded-lg transition-colors"><Icons.Edit size={16}/></button>
                                    <button onClick={() => handleDelete(c.id)} className="text-red-400 hover:bg-red-900/30 p-2 rounded-lg transition-colors"><Icons.Trash size={16}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
